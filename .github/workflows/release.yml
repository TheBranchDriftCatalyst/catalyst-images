name: Release

on:
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: catalyst-images

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        variant:
          - minimal
          - base
          - k8s
          - python
          - node
          - go
          - full
          - hacker

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ${{ matrix.variant }} with Nix
        run: |
          cd nix
          nix build .#docker-${{ matrix.variant }} --out-link result-${{ matrix.variant }}
          ./result-${{ matrix.variant }} | docker load

      - name: Tag and push ${{ matrix.variant }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          REPO="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"

          # Tag with variant
          docker tag ${{ env.IMAGE_NAME }}:${{ matrix.variant }} ${REPO}:${{ matrix.variant }}

          # Tag with variant and version
          docker tag ${{ env.IMAGE_NAME }}:${{ matrix.variant }} ${REPO}:${{ matrix.variant }}-${VERSION}

          # Push all tags
          docker push ${REPO}:${{ matrix.variant }}
          docker push ${REPO}:${{ matrix.variant }}-${VERSION}

      - name: Push latest tag for full variant
        if: matrix.variant == 'full'
        run: |
          REPO="${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}"
          docker tag ${{ env.IMAGE_NAME }}:full ${REPO}:latest
          docker push ${REPO}:latest

  create-release:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.VERSION }}
          body: |
            ## Docker Images

            Pull from GitHub Container Registry:
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/catalyst-images:<variant>
            ```

            ### Available variants:
            - `minimal` - Bare essentials (zsh, git, curl)
            - `base` - Standard dev tools (starship, fzf, ripgrep, bat, neovim)
            - `k8s` - Kubernetes tools (kubectl, k9s, helm, kustomize)
            - `python` - Python development (python 3.12, poetry, ruff)
            - `node` - Node.js development (node 20, npm, yarn, pnpm)
            - `go` - Go development (go, gopls, golangci-lint)
            - `full` - Everything combined
            - `hacker` - Security/hacking tools

            See [CHANGELOG.md](CHANGELOG.md) for detailed changes.
          generate_release_notes: true
